Auth0 User Provisioning via Custom Token ExchangeThis documentation describes the logic required in the Auth0 Custom Token Exchange Action and the Custom Database Scripts (getUser and create) to provision users into the Auth0 database without traditional password flows.This architecture is triggered by calling the /oauth/token endpoint with a custom subject_token.Architecture FlowThe entire process is initiated by the Custom Token Exchange Action, which validates the incoming token and calls api.authentication.setUserByConnection. This function triggers the Custom Database Scripts if the user does not exist.The final fix ensures that the user_id generated by the database scripts exactly matches the user_id passed by the Action, and that the returned profile includes email_verified: true to satisfy Auth0's verification requirements for a passwordless flow.Sequence Diagram: Successful ProvisioningThis diagram illustrates the flow when a new user is created ("provisioned") via the token exchange.sequenceDiagram
    participant C as Client (cURL)
    participant A as Custom Token Exchange Action
    participant P as Auth0 Pipeline
    participant G as DB Script: getUser
    participant D as DB Script: create
    participant E as External User Store

    C->>A: POST /oauth/token (subject_token: "user_id:email")
    A->>P: api.authentication.setUserByConnection(user_id, email, create_if_not_exists)
    P->>G: 1. call getUser(email)
    G->>E: Check for user ID ('user_id')
    E-->>G: User not found
    G-->>P: callback(null)
    P->>D: 2. call create(user)
    D->>D: Generate user_id (e.g., 'newuser_onthefly12')
    D->>E: Write {email: user_id}
    D-->>P: callback(null, {user_id, email, email_verified: true})
    P->>G: 3. call getUser(email) [Final Check]
    G->>E: Check for user ID
    E-->>G: Found User ID
    G-->>P: callback(null, {user_id, email, email_verified: true})
    P-->>C: Issue Access Token, ID Token, Refresh Token
